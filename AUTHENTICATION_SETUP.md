# Authentication Setup Guide

## âœ… What's Been Implemented

### **Phase 1: Authentication Foundation** (COMPLETE)

1. **NextAuth.js Integration** âœ…
   - Credentials provider (email/password)
   - Google OAuth ready (optional)
   - JWT session strategy
   - Prisma adapter for database persistence

2. **Database Schema** âœ…
   - PostgreSQL with Prisma ORM
   - User, Account, Session, VerificationToken models
   - TasteGenome model with all fields (axes, hexagram, keywords, XP)
   - ApiKey model for external API access

3. **Authentication Pages** âœ…
   - `/auth/signin` - Sign in page (gothic aesthetic)
   - `/auth/signup` - Create account page
   - Signup API endpoint

4. **Configuration Files** âœ…
   - `prisma/schema.prisma` - Database schema
   - `.env` - Environment variables
   - `lib/auth.ts` - NextAuth configuration
   - `lib/prisma.ts` - Prisma client singleton

---

## ğŸš€ Setup Instructions

### **Step 1: Install PostgreSQL**

#### Option A: Use Prisma Dev (Easiest)
```bash
# Run Postgres locally in your terminal
npx prisma dev
```

#### Option B: Docker
```bash
docker run --name subtaste-postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=subtaste \
  -p 5432:5432 \
  -d postgres:16
```

#### Option C: Install Locally
- macOS: `brew install postgresql@16`
- Ubuntu: `sudo apt install postgresql`
- Windows: Download from postgresql.org

### **Step 2: Run Database Migrations**

```bash
# Generate Prisma Client
npx prisma generate

# Create database and run migrations
npx prisma migrate dev --name init

# (Optional) Open Prisma Studio to view data
npx prisma studio
```

### **Step 3: Start the Development Server**

The server should already be running on port 3000. If not:

```bash
pnpm dev
```

### **Step 4: Test Authentication**

1. **Create Account:**
   - Visit: http://localhost:3000/auth/signup
   - Enter name, email, password
   - Auto-redirects to /training after signup

2. **Sign In:**
   - Visit: http://localhost:3000/auth/signin
   - Use credentials you just created
   - Redirects to /profile

3. **Check Database:**
   - Run `npx prisma studio`
   - See users and sessions in browser

---

## ğŸ“ File Structure

```
subtaste-twelve/
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma          # Database schema
â”œâ”€â”€ apps/web/
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ app/
â”‚       â”‚   â”œâ”€â”€ api/
â”‚       â”‚   â”‚   â””â”€â”€ auth/
â”‚       â”‚   â”‚       â”œâ”€â”€ [...nextauth]/route.ts  # NextAuth handler
â”‚       â”‚   â”‚       â””â”€â”€ signup/route.ts         # Signup endpoint
â”‚       â”‚   â””â”€â”€ auth/
â”‚       â”‚       â”œâ”€â”€ signin/page.tsx
â”‚       â”‚       â””â”€â”€ signup/page.tsx
â”‚       â””â”€â”€ lib/
â”‚           â”œâ”€â”€ auth.ts        # NextAuth config
â”‚           â””â”€â”€ prisma.ts      # Prisma client
â””â”€â”€ .env                       # Environment variables
```

---

## ğŸ”§ Environment Variables

Your `.env` file contains:

```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/subtaste?schema=public"
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="<auto-generated>"

# Optional: Google OAuth
GOOGLE_CLIENT_ID=""
GOOGLE_CLIENT_SECRET=""
```

---

## ğŸ¯ Next Steps

### **Still To Implement:**

1. **Migrate API Routes to Prisma** (Task #13)
   - Update `/api/v2/quiz` to use database
   - Update `/api/v2/training` to use database
   - Update `/api/v2/axes` to use database
   - Replace `localStorage` usage with sessions

2. **Add API Key System** (Task #14)
   - Generate API keys for external apps
   - Add API key authentication middleware
   - Enable Slayt/Tessera integration

3. **Update Client-Side Auth** (Task #15)
   - Replace `localStorage.getItem('subtaste_user_id')` with session
   - Add protected route middleware
   - Add login redirects

4. **Add CORS** (Task #16)
   - Configure CORS for external APIs
   - Add rate limiting
   - Create API documentation

---

## ğŸ§ª Testing the Auth Flow

### **Manual Test:**
```bash
# 1. Visit signup page
open http://localhost:3000/auth/signup

# 2. Create account with:
# - Name: Test User
# - Email: test@example.com
# - Password: password123

# 3. Should auto-login and redirect to /training

# 4. Sign out and sign back in
open http://localhost:3000/auth/signin
```

### **Database Test:**
```bash
# View users in database
npx prisma studio

# Or query via CLI
npx prisma db execute --stdin <<< "SELECT * FROM users;"
```

---

## ğŸ› Troubleshooting

### **Issue: Database connection failed**
```bash
# Check if Postgres is running
psql -U postgres -c "SELECT version();"

# Or use Prisma Dev
npx prisma dev
```

### **Issue: Migration failed**
```bash
# Reset database and re-run migrations
npx prisma migrate reset
npx prisma migrate dev
```

### **Issue: Auth not working**
```bash
# Check NEXTAUTH_SECRET is set
cat .env | grep NEXTAUTH_SECRET

# Verify NextAuth route exists
curl http://localhost:3000/api/auth/signin
```

---

## ğŸ“Š Database Schema Overview

### **User Model**
- `id` - Unique identifier
- `email` - Login email (unique)
- `password` - Hashed password
- `name` - Display name
- **Relations:** tasteGenome, apiKeys, sessions

### **TasteGenome Model**
- Archetype classification (primary, secondary, confidence)
- Personality axes (4 dimensions, 0-1 range)
- I Ching hexagram reading
- Keywords (visual + content)
- Gamification (XP, tier, achievements)
- Stages completed, signal count

### **ApiKey Model**
- For external API access (Slayt, Tessera)
- Permissions: ["read", "write"]
- Auto-expires after period

---

## âœ¨ What's Working Now

- âœ… Sign up with email/password
- âœ… Sign in and maintain session
- âœ… Database persistence (no more localStorage!)
- âœ… Gothic aesthetic auth pages
- âœ… Auto-redirect after signup
- âœ… Ready for API key generation

---

## ğŸš§ Status

**Current Progress: ~40% Complete**

- [x] Authentication infrastructure
- [x] Database schema
- [x] Auth pages
- [ ] Migrate existing APIs
- [ ] API key system
- [ ] Client-side auth updates
- [ ] CORS + documentation

**Next:** Run database migrations and test the auth flow!
